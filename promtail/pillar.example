# NEW: config_global_part + config_scrape_parts (recommended for multi-pillar merge)
#
# Split promtail config into two pieces that live in SEPARATE pillar SLS files:
#   config_global_part  — string: everything above scrape_configs (server, clients, limits…)
#   config_scrape_parts — dict:  each key is a unique name, value is a YAML string
#                         containing one or more `- job_name: …` blocks
#
# Salt deep-merges dicts, so when multiple pillar SLS files each add their own
# key to config_scrape_parts, all keys end up in the compiled pillar.
# The formula iterates over all values (sorted by key) and assembles them under
# `scrape_configs:`.
#
# If config_scrape_parts is empty or absent, a default stub job is used (no errors).
#
# Targeting is done ONLY via top_sls — job pillar SLS files contain no targets.
#
# See pillar/promtail/examples/ for complete working examples.

# --- Global pillar (attach to '*' in top_sls) ---
promtail:
  binary:
    link: https://github.com/grafana/loki/releases/download/v2.7.3/promtail-linux-amd64.zip
  config_global_part: |
    server:
      http_listen_port: 9080
      grpc_listen_port: 0
    positions:
      filename: /tmp/positions.yaml
    clients:
      - url: https://loki.example.com/loki/api/v1/push
    limits_config:
      readline_rate_enabled: true
      readline_rate_drop: false

# --- Job pillar (attach to matching servers in top_sls) ---
promtail:
  config_scrape_parts:
    nginx_access: |
      - job_name: nginx_access_logs
        static_configs:
        - labels:
            job: nginx
            __path__: /var/log/nginx/*access.log

# --- Another job pillar (same server can get both) ---
promtail:
  config_scrape_parts:
    mysql_slowlog: |
      - job_name: mysql_slowlog
        static_configs:
        - labels:
            job: mysql_slowlog
            __path__: /var/log/mysql/*slow.log

# FULL CONFIG pillar example (single pillar, no merge)

{%- set promtail_version = "2.7.3" -%}
{%- set host = grains['fqdn'] -%}
{%- set loki_server = "loki.example.com" -%}

promtail:
  binary:
    link: https://github.com/grafana/loki/releases/download/v{{ promtail_version }}/promtail-linux-amd64.zip
  acme_domain: {{ grains['fqdn'] }}
  config: |
    server:
      http_listen_port: 9080
      grpc_listen_port: 0
    positions:
      filename: /opt/promtail/etc/positions.yaml
    clients:
      - url: https://{{ loki_server }}/loki/api/v1/push
        tenant_id: loki-cluster
        backoff_config:
          max_retries: 20
    limits_config:
      readline_rate_enabled: true
      readline_rate_drop: false
    scrape_configs:
    - job_name: fastly_syslog
      syslog:
        listen_address: 0.0.0.0:514
        tls_config:
          cert_file: /opt/acme/cert/promtail_{{ grains['fqdn'] }}_fullchain.cer
          key_file: /opt/acme/cert/promtail_{{ grains['fqdn'] }}_key.key
        #use_rfc5424_message: true
        labels:
          job: fastly
          env: test
    - job_name: test
      pipeline_stages:
      - json:
          expressions:
            timestamp: datetime
      - timestamp:
          source: timestamp
          format: '02/Jan/2006:15:04:05 -0700'
          location: UTC
      static_configs:
      - labels:
          job: test
          host: {{ host }}
          __path__: /mnt/generated*log
    - job_name: multiline-test
      static_configs:
      - labels:
          job: test-log-files
          test_lable: test-log-file
          host: {{ host }}
          __path__: /tmp/*test.log
      pipeline_stages:
       - multiline:
           firstline: '^SOL:'
           max_wait_time: 3s
       - regex:
           # Flag (?s:.*) needs to be set for regex stage to capture full traceback log in the extracted map.
           expression: '^SOL: (?P<message>(?s:.*))$'
       - output:
           source: message

# LEGACY pillar example (single pillar, no merge, hardcoded values)

{%- set host = "server1.example.com" -%}
promtail:
  loki:
    url: https://loki.example.com
    auth_basic:
      username: <user>
      password: <password>
  binary:
    link: https://github.com/grafana/loki/releases/download/v2.3.0/promtail-linux-amd64.zip
  docker:
    image: grafana/promtail:2.3.0
    binds:
      - bind: /var/log:/var/log
      - bind: /opt/app-1/log:/var/log/app-1/log
  scrape_configs: |
    - job_name: nginx
      static_configs:
      - labels:
          job: nginx
          host: {{ host }}
          __path__: /var/log/nginx/*log
    - job_name: app-1
      static_configs:
      - labels:
          job: app-1
          host: {{ host }}
          __path__: /var/log/app-1/*log

